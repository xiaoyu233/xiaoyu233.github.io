<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Aosp编译 - xiaoyu233&#039;s blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="xiaoyu233&#039;s blog"><meta name="msapplication-TileImage" content="https://xiaoyu233.github.io/webp/shino.webp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="xiaoyu233&#039;s blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="自从年少无知（′д｀ ）掉进了Android开发的坑后，就一直想编译一波Aosp，无奈通过我大局域网拉取那几十G的Android源码，实在过于梦幻。在一开始看教程，还尝试从清华镜像源拉取源码，但可能是他们钞能力不够了吧，每次同步一会儿就嗝屁了。"><meta property="og:type" content="blog"><meta property="og:title" content="Aosp编译"><meta property="og:url" content="https://xiaoyu233.github.io/2020/05/05/aosp-build/"><meta property="og:site_name" content="xiaoyu233&#039;s blog"><meta property="og:description" content="自从年少无知（′д｀ ）掉进了Android开发的坑后，就一直想编译一波Aosp，无奈通过我大局域网拉取那几十G的Android源码，实在过于梦幻。在一开始看教程，还尝试从清华镜像源拉取源码，但可能是他们钞能力不够了吧，每次同步一会儿就嗝屁了。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://xiaoyu233.github.io/webp/1s.webp"><meta property="og:image" content="https://xiaoyu233.github.io/webp/%E8%8D%AF%E4%B8%B8.svg"><meta property="article:published_time" content="2020-05-05T14:54:13.000Z"><meta property="article:modified_time" content="2021-07-06T16:25:11.994Z"><meta property="article:author" content="xiaoyu233"><meta property="article:tag" content="aosp"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://xiaoyu233.github.io/webp/1s.webp"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaoyu233.github.io/2020/05/05/aosp-build/"},"headline":"xiaoyu233's blog","image":[],"datePublished":"2020-05-05T14:54:13.000Z","dateModified":"2021-07-06T16:25:11.994Z","author":{"@type":"Person","name":"xiaoyu233"},"description":"自从年少无知（′д｀ ）掉进了Android开发的坑后，就一直想编译一波Aosp，无奈通过我大局域网拉取那几十G的Android源码，实在过于梦幻。在一开始看教程，还尝试从清华镜像源拉取源码，但可能是他们钞能力不够了吧，每次同步一会儿就嗝屁了。"}</script><link rel="canonical" href="https://xiaoyu233.github.io/2020/05/05/aosp-build/"><link rel="icon" href="https://xiaoyu233.github.io/webp/shino.webp"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://xiaoyu233.github.io/webp/shino.webp" alt="xiaoyu233&#039;s blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/xiaoyu233"><i class="fab fa-github"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-05-05T14:54:13.000Z" title="2020-05-05T14:54:13.000Z">2020-05-05</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-07-06T16:25:11.994Z" title="2021-07-06T16:25:11.994Z">2021-07-06</time></span><span class="level-item">7 minutes read (About 1093 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Aosp编译</h1><div class="content"><p>自从<del>年少无知</del><code>（′д｀ ）</code>掉进了<code>Android</code>开发的坑后，就一直想编译一波<code>Aosp</code>，无奈通过我大局域网拉取那几十G的<code>Android</code>源码，实在过于梦幻。在一开始看教程，还尝试从清华镜像源拉取源码，但可能是他们钞能力不够了吧，每次同步一会儿就嗝屁了。</p>
<a id="more"></a>

<p>不过即使我把代码拉下来了，我原先那渣渣配置笔记本来编译怕不是要原地上天呀<code>（ ‵▽′）ψ</code>。</p>
<p>直到最近自己配了台式，性能上比笔记本高到不知道那里去了。后面又花了30大洋<del>巨资</del>买了个梯子，直接拉谷歌服务器上的源码，不快但比较稳定，毕竟跑的快不一定成功嘛<code>(～￣▽￣)～</code>，可以开始编译编译啦。</p>
<p>首先是编译环境的选择，自己现在使用黑苹果，看教程也有使用苹果系统进行编译的，不过似乎因为文件系统的原因，需要创建一个新的分区挂载，在新分区中进行编译工作。想想操作越多越可能出错，就选择<code>Ubuntu Server 18.04</code>作为编译环境。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># installl jdk</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install openjdk-8-jdk</span><br><span class="line">java -version</span><br><span class="line"></span><br><span class="line"># install the necessary tools</span><br><span class="line">sudo apt-get install bison g++-multilib git gperf libxml2-utils make zlib1g-dev:i386 zip liblz4-tool libncurses5 libssl-dev bc flex</span><br><span class="line"></span><br><span class="line"># Download Repo</span><br><span class="line">mkdir ~&#x2F;bin</span><br><span class="line">curl http:&#x2F;&#x2F;commondatastorage.googleapis.com&#x2F;git-repo-downloads&#x2F;repo &gt; ~&#x2F;bin&#x2F;repo</span><br><span class="line">chmod a+x ~&#x2F;bin&#x2F;repo</span><br><span class="line">export PATH&#x3D;~&#x2F;bin:$PATH</span><br><span class="line"></span><br><span class="line"># Download the Aosp</span><br><span class="line">mkdir ~&#x2F;android</span><br><span class="line">cd ~&#x2F;android</span><br><span class="line">repo init -u https:&#x2F;&#x2F;android.googlesource.com&#x2F;platform&#x2F;manifest -b &lt;branch&gt;</span><br><span class="line">export http_proxy&#x3D;http:&#x2F;&#x2F;xxxx.xxx:port</span><br><span class="line">export https_proxy&#x3D;http:&#x2F;&#x2F;xxxx.xxx:port</span><br><span class="line">repo sync</span><br><span class="line"></span><br><span class="line"># Build Aosp images</span><br><span class="line">source build&#x2F;envsetup.sh</span><br><span class="line"># Select the target devices</span><br><span class="line">lunch</span><br><span class="line"># Start the build</span><br><span class="line">make -j&amp;(nproc)</span><br></pre></td></tr></table></figure>

<p>我的编译过程总体还算比较顺利，失败几次后编译成功了，还好没有卡住。说一说我遇到的坑吧。</p>
<h2 id="资源问题"><a href="#资源问题" class="headerlink" title="资源问题"></a>资源问题</h2><p>这个问题很好发现排查，在编译过程中可以新开一个窗口，运行<code>atop</code>查看系统资源使用情况。在经历两次内存不足而导致编译进程被杀后，将内存调整至<code>10G</code>（宿主机总内存<code>16G</code>）并分配<code>10G</code>的<code>Swap</code>，顺便将编译的线程数降低，再次编译可以通过前期大部分系统底层编译至末尾<code>Framework</code>层编译，没有发现进程被杀现象。</p>
<h2 id="python版本问题"><a href="#python版本问题" class="headerlink" title="python版本问题"></a>python版本问题</h2><p>在编译之前我想都<code>0202</code>年了，应该不需要用<code>python2.7</code>了吧，想来我还是<code>too young, too simple</code>，前面解决系统资源问题后，日志显示编译工作已经完成，但在打包镜像的过程中失败了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">print &quot;&#39;%s&#39; cannot be converted to int&quot; % (line[2])</span><br><span class="line">                                          ^</span><br><span class="line">SyntaxError: invalid syntax</span><br></pre></td></tr></table></figure>

<p>错误定位在<code>mk_combined_img.py</code>中</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    partition_info[<span class="string">&quot;num&quot;</span>] = <span class="built_in">int</span>(line[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">except</span> ValueError:</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;&#x27;%s&#x27; cannot be converted to int&quot;</span> % (line[<span class="number">2</span>])</span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>功能似乎是根据配置文件<code>system-qemu-config.txt</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">out&#x2F;target&#x2F;product&#x2F;generic_x86&#x2F;vbmeta.img vbmeta 1</span><br><span class="line">out&#x2F;target&#x2F;product&#x2F;generic_x86&#x2F;super.img super 2</span><br></pre></td></tr></table></figure>

<p>生成<code>system-qemu.img</code>，内部调用<code>sgdisk</code>工具。</p>
<p>不过从出错的函数看，应该与该文件主功能关联不大，应该不是<code>sgdisk</code>工具的问题。</p>
<p>这时已经在两次完整编译后晚上1点过了，想想还是不修仙了。</p>
<p><img src="https://xiaoyu233.github.io/webp/1s.webp"></p>
<p>第二天，又尝试了几次，还是不行，突然想到会不会与<code>python</code>版本有关，自己呢对这胶水语言又不是很熟悉，就把之前出错的函数抽来，用<code>python2.7</code>和<code>python3.6</code>测试，结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~&#x2F;Desktop$ python2 test.py </span><br><span class="line">~&#x2F;Desktop$ python3 test.py </span><br><span class="line">  File &quot;test.py&quot;, line 32</span><br><span class="line">    print &quot;&#39;%s&#39; cannot be converted to int&quot; % (line[2])</span><br><span class="line">                                          ^</span><br><span class="line">SyntaxError: invalid syntax</span><br></pre></td></tr></table></figure>

<p><img src="https://xiaoyu233.github.io/webp/%E8%8D%AF%E4%B8%B8.svg"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总之，这次编译<code>Aosp</code>总算完成了，编译了<code>X86</code>的镜像，后面试试可以运行不。</p>
<p>接触<code>Android</code>开发只有一年多点，技术总在不断变化中，<code>Jatpack MVVM</code>、<code>Flutter</code>以及将来的<code>Jatpack Compose</code>，有时总担心自己一回头发现自己总写业务，留自己的东西太少。所以嘛<code>(。・_・)/</code>希望这次是一个好的开端，更多地探索为什么。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Aosp编译</p><p><a href="https://xiaoyu233.github.io/2020/05/05/aosp-build/">https://xiaoyu233.github.io/2020/05/05/aosp-build/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>xiaoyu233</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2020-05-05</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2021-07-06</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/aosp/">aosp</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/06/13/nas-ups/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">添置ups</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/01/01/hello-world/"><span class="level-item">hello world</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://xiaoyu233.github.io/webp/shino.webp" alt="xiaoyu233"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">xiaoyu233</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>ChengDu</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">7</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">4</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/xiaoyu233" target="_blank" rel="noopener">Follow</a></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">May 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">March 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">November 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">July 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">June 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">May 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">January 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/aosp/"><span class="tag">aosp</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gpu-passthrough/"><span class="tag">gpu-passthrough</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/notes/"><span class="tag">notes</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ups/"><span class="tag">ups</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://xiaoyu233.github.io/webp/shino.webp" alt="xiaoyu233&#039;s blog" height="28"></a><p class="is-size-7"><span>&copy; 2021 xiaoyu233</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><script src="/js/main.js" defer></script><!--!--></body></html>